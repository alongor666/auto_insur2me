车险变动成本多维分析系统 · 仓库指南

## 角色定位与协作准则

- 扮演世界顶级架构师、资深前端工程师与数据架构师，负责交付高性能、可扩展的 Next.js 14 + TypeScript 解决方案。
- 扮演麦肯锡级业务顾问与车险精算专家，确保所有指标、洞察、建议与实际数据高度贴合。
- 扮演数据工程专家，准确解读 CSV 数据架构、目录结构与字段口径，并持续维护数据治理规范。
- 所有代码、文档、注释与沟通均使用中文；函数需提供中文函数级注释，说明功能、参数与返回值。
- 在任何实现、重构或文档更新前，优先对照 `prd.md` 及 `多维分析系统数据规范` 文件夹，确保口径一致、信息同步。

## 快速索引（对应 PRD）

| 主题 |  位置 | PRD 章节 |
|------|---------------|----------|
| 项目背景与目标 | [产品概览](#产品概览) | 1.1-1.3 |
| 数据架构与字段体系 | [数据架构与字段规范](#数据架构与字段规范) | 2.1、2.2 |
| AI 核心处理流程 | [AI 核心处理逻辑](#ai-核心处理逻辑) | 2.1-2.3 |
| 核心功能模块 | [核心功能需求](#核心功能需求) | 3.1-3.3 |
| 体验与交互标准 | [体验与交互要求](#体验与交互要求) | 4.1-4.2 |
| 验收与术语 | [关键验收与术语](#关键验收与术语) | 5.1-5.2 |

## 产品概览

### 项目背景
四川分公司在车险变动成本管控上存在数据分散、口径不一、分析滞后等问题，亟需构建“车险变动成本多维分析系统”，实现统一数据标准、实时监控与智能洞察。

### 核心目标
1. **成本核算自动化**：统一 17 个维度与 9 个绝对值字段的数据标准，实现批量导入与自动核算。
2. **风险智能预警**：围绕变动成本率、满期赔付率等关键指标实时监控，识别高风险业务单元。
3. **决策支持可视化**：构建交互式仪表盘，为趋势分析、对比分析、风险分析、盈利能力分析提供支撑。

### 北极星指标与性能要求
- **北极星指标**：完整分析路径（数据加载 → 指标筛选 → 洞察输出）≤ 30 秒。
- **查询性能**：单次查询默认覆盖 ≤15 周（≈45 万行），后端聚合响应 < 2 秒，前端首屏渲染 < 3 秒。
- **批量计算**：核心 KPI 计算 < 1 秒，确保交互丝滑。

### 关键业务指标
- 变动成本率、满期赔付率、费用率、边际贡献率为监控重点；其定义与计算必须与 PRD “关键指标” 章节保持一致。
- 商业险自主定价系数、保费时间进度达成率、单均保费、案均赔款等指标用于补充盈利与履约洞察。

## 数据架构与字段规范

所有字段、目录、命名、计算规则必须与 `多维分析系统数据规范` 文件夹完全一致，并以 PRD 引导的 17+9+7+2+1 体系为准。

### 目录与命名
- 数据根目录统一为 `data/`。
- 周度文件命名 `{年度}保单第{周次}周变动成本明细表.csv`，示例：`2025保单第33周变动成本明细表.csv`。
- 元数据文件位于 `data/metadata/`：`available_years.json`、`available_weeks.json`、`data_catalog.json`，用于智能发现与前端下拉联动。
- 历史归档数据存放于 `data/archive/data-{YYYY}/`，结构与主目录一致。

### 字段分类体系
- **筛选维度字段（17 个）**：时间、机构、业务、车辆属性、风险评级五大类，字段、选项需与 `多维分析系统字段选项明细.md` 保持同步，前端筛选组件基于此生成。
- **绝对值字段（9 个）**：`signed_premium_yuan`、`matured_premium_yuan`、`commercial_premium_before_discount_yuan`、`policy_count`、`claim_case_count`、`reported_claim_payment_yuan`、`expense_amount_yuan`、`premium_time_progress_plan_yuan`（旧数据映射 `premium_plan_yuan`）、`marginal_contribution_amount_yuan`。
- **率值字段（7 个）**：`expense_ratio_percent`、`maturity_ratio_percent`、`claim_frequency_percent`、`matured_loss_ratio_percent`、`variable_cost_ratio_percent`、`marginal_contribution_ratio_percent`、`premium_time_progress_achievement_rate_percent`。
- **均值字段（2 个）**：`average_premium_per_policy_yuan`、`average_claim_payment_yuan`。
- **系数字段（1 个）**：`commercial_auto_underwriting_factor`（仅适用 `insurance_type = "商业保险"` 且分母>0）。

### 精度与数据治理
- 金额/计划类字段均使用 `numeric(18,4)` 存储，界面可按需求转换为万元显示。
- 比率类字段使用 `numeric(10,6)` 存储，前端展示保留 1 位小数。
- 件数类字段 (`policy_count`、`claim_case_count`) 使用 `bigint`，展示整数。
- 系数字段保留 4 位小数。
- 分母为 0 时立即返回 `NULL` 或 0（按 PRD 约定），同时触发告警提示。

## 核心指标体系

所有指标需遵循“先聚合绝对值，再计算比率”的总原则，计算口径以 `上传CSV文件字段规范.md` 为准：

### 绝对值字段（9）
1. `SUM(signed_premium_yuan)` —— 签单保费。
2. `SUM(matured_premium_yuan)` —— 满期保费。
3. `SUM(commercial_premium_before_discount_yuan)` —— 商业险折前保费。
4. `SUM(policy_count)` —— 保单件数。
5. `SUM(claim_case_count)` —— 赔案件数。
6. `SUM(reported_claim_payment_yuan)` —— 已报告赔款。
7. `SUM(expense_amount_yuan)` —— 费用金额。
8. `SUM(premium_time_progress_plan_yuan)` —— 保费时间进度计划。
9. `SUM(marginal_contribution_amount_yuan)` —— 满期边际贡献额（说明：仅为满期口径，非终极边际贡献额）。

### 率值字段（7）
1. `expense_ratio_percent = (Σ费用金额 ÷ Σ签单保费) × 100`。
2. `maturity_ratio_percent = (Σ满期保费 ÷ Σ签单保费) × 100`。
3. `claim_frequency_percent = (Σ赔案件数 ÷ Σ保单件数) × (Σ满期保费 ÷ Σ签单保费) × 100`。
4. `matured_loss_ratio_percent = (Σ已报告赔款 ÷ Σ满期保费) × 100`。
5. `variable_cost_ratio_percent = [(Σ费用金额 ÷ Σ签单保费) + (Σ已报告赔款 ÷ Σ满期保费)] × 100`。
6. `marginal_contribution_ratio_percent = (Σ满期边际贡献额 ÷ Σ满期保费) × 100 = 100 - 满期赔付率 - (Σ费用金额 ÷ Σ满期保费) × 100`。
7. `premium_time_progress_achievement_rate_percent = (Σ签单保费 ÷ Σ保费时间进度计划) × 100`。

### 均值字段（2）
1. `average_premium_per_policy_yuan = Σ签单保费 ÷ Σ保单件数`。
2. `average_claim_payment_yuan = Σ已报告赔款 ÷ Σ赔案件数`。

### 系数字段（1）
- `commercial_auto_underwriting_factor = Σ签单保费 ÷ Σ商业险折前保费`（仅对商业险生效，结果保留 4 位小数）。

## AI 核心处理逻辑

### 2.1 数据预处理与转换
- 基于 `DataLoader` 自动识别年度、周次、文件路径，输出可用年份、缺失周次与文件数。
- 对原始 CSV 执行字段校验、类型转换、缺失值处理（评级缺失显示为“未评级”）。
- 单次加载上限 15 周，可分片加载并缓存 24 小时；当周次缺失时需提示。

### 2.2 指标计算引擎
1. 先对 9 个绝对值字段按筛选维度聚合。
2. 使用聚合结果计算 7 个率值、2 个均值与 1 个系数指标。
3. 精确处理除零逻辑，所有计算公式需与数据规范一致。
4. 输出结构需包含全部 19 个核心指标，并保留原始维度字段用于前端映射。

### 2.3 智能分析与洞察
- **异常检测**：满期赔付率 >100% 或 <0%、费用率 >50% 或 <0%、变动成本率 >150% 或 <0%、边际贡献率 < -50% 或 >100% 均标记异常。
- **趋势洞察**：自动识别季度/周度趋势，结合变动成本率与边际贡献率提供业务结论。
- **行动建议**：生成 2-3 条可执行建议，覆盖费用优化、风险干预、渠道结构优化等角度。

## 核心功能需求

### 3.1 数据导入与集成
- 支持批量上传 CSV、增量加载与自动检测缺失周次。
- 上传流程需校验字段、单位、枚举值，错误信息按字段级别反馈。
- 数据导入成功后更新元数据并触发数据重载。

### 3.2 成本分析仪表盘
- 三大选择器：维度选择（17 个字段）、指标选择（19 个指标）、图表类型选择（折线/面积/点/热力/箱线）。
- KPI 网格提供核心指标概览；图表画布支持联动刷选、同比环比切换、单位换算。
- AI 洞察面板输出趋势解读、异常说明、建议动作。

### 3.3 风险预警与监控
- 按机构、险种、客户类型等维度配置阈值预警；当指标越界时在仪表盘和 AI 报告中提示。
- 支持导出异常列表与建议行动计划。

## 体验与交互要求

- 遵循 PRD 设计原则：简洁、易懂、可钻取；前端需支持深色/浅色模式切换。
- 关键筛选项需提供搜索、收藏、默认组合等能力；常用维度组合可一键保存。
- 图表交互遵循“所见即所得”，在选择维度时实时反馈数据加载状态与缓存命中情况。

## 开发与实现要求

- Next.js 14 App Router + TypeScript + Tailwind CSS；组件使用函数式写法。
- 数据处理层采用 `services/dataProcessor.ts`、`services/metricCalculator.ts`、`services/aiAnalyzer.ts` 等模块化结构。
- 提交代码前需编写/更新单元测试，关注 CSV 解析、聚合、异常检测、AI 分析输出。
- 代码与文档更新需同时维护 `prd.md` 与 `README.md`（活文档原则）。

## 性能与安全

- 后端 API 必须支持缓存（按维度组合缓存 24 小时）与分页；前端请求需具备取消与重试机制。
- 大文件上传采用分片与断点续传策略；临时文件存储周期 <24 小时。
- 严禁泄露客户隐私数据，脱敏展示敏感字段。

## 关键验收与术语

- **验收标准**：
  1. 按 PRD完成功能自测与文档交付（代码、API、部署、性能报告）。
  2. 指标计算结果需与既有验证报告对齐，差异 <0.1%。
  3. 性能测试满足查询、计算、渲染时延要求。
- **术语统一**：
  - “变动成本率”“满期赔付率”等指标名称不得改写。
  - “保费时间进度计划”统一使用 `premium_time_progress_plan_yuan` 字段描述。
  - “多维分析系统数据规范” 为字段、目录、口径的唯一权威来源。

## 关键文档清单

- `./prd.md`
- `./多维分析系统数据规范/上传CSV文件字段规范.md`
- `./多维分析系统数据规范/多维分析系统字段选项明细.md`
- `./多维分析系统数据规范/多维分析系统数据说明.md`