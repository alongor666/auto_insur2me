# 车险变动成本多维分析系统 · 产品需求文档（PRD）

**版本**: v0.1  
**最后更新**: 2025-09-16

---

## 0. 文档导读

| 快速入口 | 说明 |
| --- | --- |
| 项目速览 | [1. 产品概述](#1-产品概述) |
| 数据与口径 | [2. 数据架构与治理](#2-数据架构与治理) |
| 关键功能 | [3. 功能需求](#3-功能需求) |
| AI 流程 | [4. AI 核心处理逻辑](#4-ai-核心处理逻辑) |
| 体验规范 | [5. 用户体验设计](#5-用户体验设计) |
| 验收标准 | [7. 验收与交付](#7-验收与交付) |
| 术语与参考 | [8. 术语与参考文档](#8-术语与参考文档) |

**相关文件**（权威来源）
- `./多维分析系统数据规范/上传CSV文件字段规范.md`
- `./多维分析系统数据规范/多维分析系统字段选项明细.md`
- `./多维分析系统数据规范/多维分析系统数据说明.md`
- `./README.md`

---

## 1. 产品概述

### 1.1 项目背景
四川分公司在车险业务经营中存在变动成本核算口径不一致、数据分散、分析滞后等问题。为满足监管要求及市场竞争需求，需构建“车险变动成本多维分析系统”，以统一数据标准、提升风险识别效率，并为管理层提供可视化决策支持。

### 1.2 核心目标
1. **成本核算自动化**：统一 17 个筛选维度与 9 个绝对值字段的数据标准，实现批量导入与自动核算。
2. **风险智能预警**：围绕变动成本率、满期赔付率等关键指标实时监控，识别高风险业务单元。
3. **决策支持可视化**：打造多维互动仪表盘，支持趋势、对比、风险、盈利等分析场景。

### 1.3 成功指标
- **北极星指标**：一次完整分析路径（数据加载 → 指标筛选 → 洞察输出）≤ 30 秒。
- **核心业务指标**：变动成本率、满期赔付率、费用率、边际贡献率，定义与计算与数据规范完全一致。
- **性能指标**：单次查询默认覆盖 ≤15 周（≈45 万行），聚合响应 < 2 秒，前端首屏渲染 < 3 秒，核心 KPI 计算 < 1 秒。

### 1.4 项目范围
- **包含**：数据导入与智能发现、指标计算引擎、仪表盘与图表、AI 洞察、风险预警、导出与缓存机制。
- **不包含**：对外部客户开放、保单承保/理赔操作、财务记账、移动端 App。

---

## 2. 数据架构与治理

### 2.1 目录与命名规范
- 数据根目录：`data4dash/`；年度子目录：`data-{YYYY}/`。
- 周度文件命名：`{年度}保单第{周次}周变动成本明细表.csv`，示例 `2025保单第33周变动成本明细表.csv`。
- 元数据目录：`data4dash/metadata/`，维护 `available_years.json`、`available_weeks.json`、`data_catalog.json` 等，供自动发现与前端联动。
- 历史归档目录：`data4dash/archive/data-{YYYY}/`，结构与主目录一致。

### 2.2 字段分类体系
字段、口径、精度按照 `上传CSV文件字段规范.md` 执行：
- **筛选维度（17 个）**：时间、机构、业务、车辆属性、风险评级五大类，枚举值详见 `多维分析系统字段选项明细.md`。
- **绝对值字段（9 个）**：`signed_premium_yuan` 等九项，单位统一为“元”，用于聚合计算。
- **率值字段（7 个）**：`expense_ratio_percent` 等七项，聚合后按规范公式计算。
- **均值字段（2 个）**：`average_premium_per_policy_yuan`、`average_claim_payment_yuan`。
- **系数字段（1 个）**：`commercial_auto_underwriting_factor`，仅适用于商业险且分母>0。

### 2.3 精度与质量要求
- 金额/计划类使用 `numeric(18,4)` 存储，展示可按需要换算为万元。
- 比率类使用 `numeric(10,6)` 存储，界面保留 1 位小数。
- 件数类（保单、赔案）使用 `bigint`，展示整数。
- 系数字段保留 4 位小数。
- 分母为 0 时返回 `NULL` 或 0（依据指标定义），并触发缺失数据提示。
- 数据质量评分需覆盖完整性、准确性、一致性、及时性四个维度。

### 2.4 数据规模与性能基线
- 单周约 16,000 行 × 25 个存储字段；年度需覆盖 105 周形成完整周期。
- 支持总量级 500 万行数据的查询、聚合与前端渲染。
- 高频查询结果缓存 5 分钟；年度/周次元数据缓存 24 小时。

---

## 3. 功能需求

### 3.1 数据导入与集成
- **上传规范**：仅支持 UTF-8 编码 CSV；17 个维度 + 9 个绝对值字段为必填；字段顺序建议按规范文档排列。
- **校验流程**：字段完整性、数据类型、数值范围、枚举值、业务规则（如满期保费 ≤ 签单保费）。
- **错误处理**：实时展示错误、支持生成报告（含行号/字段/原因）、允许跳过错误行、提供修复建议。
- **预处理**：空值处理、格式标准化、重复检测、异常值识别。
- **更新模式**：全量替换、增量追加、智能合并，配合版本管理与操作日志。

### 3.2 成本分析仪表盘
- **三大选择器**：
  - *维度选择器*：17 个维度支持多选、排序、级联（如成都分公司 → 三级机构），可保存模板并查看最近组合。
  - *指标选择器*：19 个核心指标（9 绝对值 + 7 率值 + 2 均值 + 1 系数），支持收藏、单位切换、同比/环比开关。
  - *图表选择器*：折线、面积、散点、热力、箱线等，支持字段映射与联动刷选。
- **KPI 看板**：响应式网格展示 19 项指标，卡片显示当前值、周环比差异（绝对值 + 百分比）。默认对比上一周，可切换月度或自定义周期。
- **图表画布**：支持维度钻取、指标堆叠、标记异常点、导出 SVG/PNG。
- **缓存提示**：显示缓存命中与数据更新时间。

### 3.3 AI 洞察与风险监控
- **触发方式**：用户选择维度与指标后点击“分析成本趋势”。
- **洞察输出**：生成“三段式”中文报告——趋势分析、异常识别、业务洞察（含 2-3 条可执行建议）。
- **异常检测**：
  - 变动成本率 >150% 或 <0%
  - 满期赔付率 >100% 或 <0%
  - 费用率 >50% 或 <0%
  - 边际贡献率 < -50% 或 >100%
  - 保费时间进度达成率 <80%
  - 分母为 0 时返回 `NULL` 并提示缺失
- **预警管理**：可为机构/险种/客户类型配置阈值；警报等级分为严重/警告/正常，并支持导出异常列表与行动建议。

### 3.4 支撑功能
- **元数据维护**：上传成功后自动刷新可选年度与周次，供前端筛选器调用。
- **任务调度**：支持夜间批处理任务，完成数据合并、缓存刷新、预计算。
- **日志与审计**：记录数据导入、计算、洞察生成的关键操作与耗时。

---

## 4. AI 核心处理逻辑

### 4.1 数据加载
1. `DataLoader` 扫描 `data4dash/`，更新可用年度与周次，识别缺失周并输出报告。
2. 单次会话默认装载 ≤15 周数据，可按年度或周次分片加载；新数据写入后自动刷新缓存。

### 4.2 指标计算流水线
1. **聚合阶段**：按选定维度对 9 个绝对值字段执行 `SUM`（或 `COUNT`）；保留原始维度列以供前端映射。
2. **计算阶段**：基于聚合结果计算 7 个率值、2 个均值、1 个系数字段，公式与 `上传CSV文件字段规范.md` 一致。
3. **异常与数据质量处理**：捕获除零、超阈值、缺失值，生成质量标签供洞察参考。
4. **缓存阶段**：按“维度组合 + 指标列表 + 周次范围”缓存结果 5 分钟。

### 4.3 智能分析流程
1. **数据准备**：收集当前时点及历史同指标数据，构建时间序列。
2. **趋势分析**：计算环比、同比、移动平均，识别趋势方向与强度。
3. **异常检测**：结合阈值与统计方法（如 IQR、Z-Score）标记异常点。
4. **归因分析**：根据 17 个维度贡献度定位主要影响因子。
5. **洞察生成**：输出结构化 Markdown，包含结论、原因及建议。
6. **反馈学习**（预留）：记录用户反馈，为后续模型优化提供数据。

---

## 5. 用户体验设计

### 5.1 设计原则
- **清晰**：优先展示核心指标与趋势，降低视觉噪音。
- **可钻取**：支持从全局概览到具体机构/险种的逐级深入。
- **一致**：所有指标名称、单位、精度与数据规范完全一致。
- **高可用**：重要操作提供确认与撤销；加载状态及时反馈。

### 5.2 交互要点
- 支持深色/浅色模式；配色对比符合无障碍要求。
- 筛选面板提供搜索、收藏、重置、默认模板功能。
- 图表支持缩放、刷选、导出、异常点悬浮说明；展示缓存命中提示。
- AI 洞察面板可折叠，历史洞察可追溯，上次运行结果可回看。

---

## 6. 性能、安全与合规

- **性能**：查询响应 <2 秒、核心计算 <1 秒、首屏渲染 <3 秒；采用异步请求与取消机制。
- **缓存策略**：服务器端结果缓存 5 分钟；前端维度与枚举缓存 24 小时，可手动刷新。
- **安全**：仅内部网络访问；上传文件在 24 小时内自动清理；敏感数据脱敏展示。
- **审计**：记录导入、查询、洞察操作日志，至少保留 180 天。

---

## 7. 验收与交付

### 7.1 验收标准
1. 功能自测覆盖数据导入、仪表盘、AI 洞察、预警与导出；提供测试报告。
2. 指标计算结果与既有验证报告差异 <0.1%。
3. 性能测试满足第 6 节要求；包含大数据量场景。
4. 文档齐备：开发说明、API 文档、部署手册、用户指南、性能报告。

### 7.2 交付物
- 应用源代码与配置（前端、后端、脚本）。
- 数据规范同步更新（若有新增字段/公式）。
- 测试与性能报告、风险评估报告。
- 运营手册：数据导入 SOP、预警规则维护指南。

---

## 8. 术语与参考文档

| 术语 | 定义 | 参考 |
| --- | --- | --- |
| 变动成本率 | `(Σ费用金额 ÷ Σ签单保费) + (Σ已报告赔款 ÷ Σ满期保费)`，结果×100 | `上传CSV文件字段规范.md` |
| 满期赔付率 | `Σ已报告赔款 ÷ Σ满期保费` ×100 | 同上 |
| 保费时间进度计划 | 字段 `premium_time_progress_plan_yuan`，按日分解的计划值 | 同上 |
| 多维筛选维度 | 17 个枚举或布尔字段，用于切片与钻取 | `多维分析系统字段选项明细.md` |
| 数据目录规范 | `data4dash/` 下的目录与命名约定 | `多维分析系统数据说明.md` |

---

## 9. 版本记录

| 版本 | 日期 | 说明 |
| --- | --- | --- |
| v0.1 | 2025-09-16 | 初版整理，结构化对齐 CLAUDE.md 与数据规范 |

